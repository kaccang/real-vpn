#!/bin/bash
CONFIG="/etc/xray/config.json"
DOMAIN=$(cat /etc/xray/domain 2>/dev/null || echo "example.com")
TLS_PORT=443
NTLS_PORT=80
PATH_VLESS="/vless"

UA_LIST=(chrome firefox android safari)
UA=${UA_LIST[$((RANDOM % ${#UA_LIST[@]}))]}

clear

ACCOUNTS=()
last_id=""
while IFS= read -r line; do
    case "$line" in
        *'"id":'*)
            vid=$(echo "$line" | sed -n 's/.*"id":[[:space:]]*"\([^"]*\)".*/\1/p')
            last_id="$vid"
            ;;
        '#& '*)
            user=$(echo "$line" | awk '{print $2}')
            exp=$(echo "$line" | awk '{print $3}')
            if [ -n "$user" ] && [ -n "$last_id" ]; then
                ACCOUNTS+=("$user|$exp|$last_id")
            fi
            ;;
    esac
done < "$CONFIG"

if [ "${#ACCOUNTS[@]}" -eq 0 ]; then
    echo "Tidak ada akun vless (#&)"
    exit 0
fi

echo "╔══════════════════════════════╗"
echo "║         CEK VLESS XRAY       ║"
echo "╚══════════════════════════════╝"
for i in "${!ACCOUNTS[@]}"; do
    IFS="|" read -r u e id <<< "${ACCOUNTS[$i]}"
    printf " %2d. %-15s %s\n" $((i+1)) "$u" "$e"
done
echo ""

read -rp "Pilih nomor [1-${#ACCOUNTS[@]}]: " N
[[ ! "$N" =~ ^[0-9]+$ ]] && { echo "invalid"; exit 1; }
(( N<1 || N>${#ACCOUNTS[@]} )) && { echo "invalid"; exit 1; }

SEL="${ACCOUNTS[$((N-1))]}"
IFS="|" read -r USER EXP UUID <<< "$SEL"

TLS_LINK="vless://${UUID}@${DOMAIN}:${TLS_PORT}?type=ws&path=${PATH_VLESS}&host=${DOMAIN}&sni=${DOMAIN}&security=tls&encryption=none#${USER}"
NTLS_LINK="vless://${UUID}@${DOMAIN}:${NTLS_PORT}?type=ws&path=${PATH_VLESS}&host=${DOMAIN}&encryption=none#${USER}"

clear
echo "────────────────────────────"
echo "  VLESS WS ACCOUNT"
echo "────────────────────────────"
echo "User       : $USER"
echo "Expired    : $EXP"
echo "Domain     : $DOMAIN"
echo "Path       : $PATH_VLESS"
echo "User-Agent : $UA"
echo "────────────────────────────"
echo "TLS  : $TLS_LINK"
echo "NTLS : $NTLS_LINK"
echo "────────────────────────────"
read -n 1 -s -r -p "Press any key..."
command -v menu >/dev/null 2>&1 && menu
